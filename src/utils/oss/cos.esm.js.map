{"version":3,"file":"cos.esm.js","sources":["../cos-uploader.js"],"sourcesContent":["/**\n * COS 上传器\n * 封装了从 STS 获取凭证、文件 SM4 加密以及腾讯云 COS 上传的完整流程。\n * 支持：分片上传、进度回调、上传暂停。\n */\n\nimport COS from \"cos-js-sdk-v5\";\nimport { STSProvider } from \"./sts-provider.js\";\nimport { sm4 } from 'sec-crypto'\nimport { v4 as uuidv4 } from 'uuid';\n\n\n/**\n * 读取 File 为 ArrayBuffer\n */\nasync function readFileAsArrayBuffer(file) {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => resolve(reader.result);\n    reader.onerror = reject;\n    reader.readAsArrayBuffer(file);\n  });\n}\n\n/**\n * Base64 转 HEX\n */\nfunction base64toHEX(base64) {\n  const raw = window.atob(base64);\n  let HEX = \"\";\n  for (let i = 0; i < raw.length; i++) {\n    const _hex = raw.charCodeAt(i).toString(16);\n    HEX += _hex.length === 2 ? _hex : \"0\" + _hex;\n  }\n  return HEX;\n}\n\n/**\n * DataURL (Base64) 转 Blob\n */\nfunction dataURLtoBlob(dataurl) {\n  if (!dataurl || typeof dataurl !== 'string') {\n    throw new Error('dataURLtoBlob: dataurl must be a non-empty string');\n  }\n  \n  const arr = dataurl.split(\",\");\n  if (arr.length < 2) {\n    throw new Error('dataURLtoBlob: invalid data URL format, missing comma separator');\n  }\n  \n  const mimeMatch = arr[0].match(/:(.*?);/);\n  if (!mimeMatch || !mimeMatch[1]) {\n    throw new Error('dataURLtoBlob: invalid data URL format, missing MIME type');\n  }\n  \n  const mime = mimeMatch[1];\n  const bstr = window.atob(arr[1]);\n  let n = bstr.length;\n  const u8arr = new Uint8Array(n);\n  while (n--) {\n    u8arr[n] = bstr.charCodeAt(n);\n  }\n  return new Blob([u8arr], { type: mime });\n}\n\n/**\n * 使用 SM4 对二进制数据加密\n */\nfunction sm4Encrypt(arrayBuffer, kmsDataKey) {\n  const bytes = new Uint8Array(arrayBuffer);\n  const hexData = Array.from(bytes)\n    .map((b) => b.toString(16).padStart(2, \"0\"))\n    .join(\"\");\n\n  const hexDataKey = base64toHEX(kmsDataKey.dataKey);\n\n  const encryptedHex = sm4.encrypt(hexData, hexDataKey.slice(0, 32), {\n    iv: hexDataKey.slice(32, 64),\n    mode: \"cbc\",\n  });\n\n  const result = new Uint8Array(\n    encryptedHex.match(/[\\da-f]{2}/gi).map((h) => parseInt(h, 16))\n  );\n\n  return result;\n}\n\n/**\n * 将 File 加密后构造新的 Blob\n */\nasync function createEncryptedBlob(file, { kmsDataKey }) {\n  const arrayBuffer = await readFileAsArrayBuffer(file);\n  const encryptedData = sm4Encrypt(arrayBuffer, kmsDataKey);\n  return new Blob([encryptedData], { type: file.type });\n}\n\nexport class CosUploader {\n  constructor() {\n    this.stsProvider = new STSProvider();\n  }\n\n  /**\n   * 全局配置\n   */\n  static config(options) {\n    STSProvider.config(options);\n  }\n\n  /**\n   * 上传单个文件\n   * @param {File|Blob|string} file - 要上传的文件\n   * @param {string} bizCode - 业务编码\n   * @param {Object} options - 配置项\n   */\n  async upload(file, bizCode, options = {}) {\n    if (!file || !bizCode) {\n      throw new Error(\"CosUploader: file and bizCode are required\");\n    }\n\n    try {\n      // 0. 归一化输入\n      let normalizedFile = file;\n      if (typeof file === \"string\" && file.startsWith(\"data:\")) {\n        normalizedFile = dataURLtoBlob(file);\n      }\n\n        // --- 新增：HTML 文件校验逻辑 ---\n      const checkName = normalizedFile.name || \"\";\n      const checkType = normalizedFile.type || \"\";\n      const isHtml = checkName.toLowerCase().endsWith('.html') || \n                     checkName.toLowerCase().endsWith('.htm') || \n                     checkType === 'text/html';\n\n      if (isHtml && !options.allowHTML) {\n        const errorMsg = \"暂不支持上传 HTML 格式文件\";\n        if (typeof window !== 'undefined' && window.alert) {\n          window.alert(errorMsg);\n        }\n        throw new Error(`OssUploader: ${errorMsg}`);\n      }\n\n      // 1. 获取 STS 凭证\n      const stsData = await this.stsProvider.getCredentials({ bizCode });\n\n      // 2. 处理文件加密\n      let uploadFile = normalizedFile;\n      let headers = {};\n\n      if (stsData.encryptEnable) {\n        if (stsData.kmsDataKey && stsData.kmsDataKey.sm4Supported) {\n          uploadFile = await createEncryptedBlob(normalizedFile, stsData)\n          headers = {\n            'x-cos-meta-encrypted-version': String(stsData.kmsDataKey.version),\n            'x-cos-meta-encrypted-data-key': String(stsData.kmsDataKey.dataKeyEncrypted),\n            'x-cos-meta-sm4-supported': '1'\n          }\n        } else if (typeof options.externalEncrypt === 'function') {\n          const { encryptedFile, meta: extraMeta } = await options.externalEncrypt(normalizedFile, stsData)\n          uploadFile = encryptedFile\n          // 将 meta 转换为 x-cos-meta- 前缀\n          if (extraMeta) {\n            Object.keys(extraMeta).forEach(key => {\n              headers[`x-cos-meta-${key}`] = extraMeta[key];\n            });\n          }\n        } else {\n          console.warn('CosUploader: encryptEnable=true 但不支持 SM4，按未加密处理')\n        }\n      }\n\n      // 3. 准备 COS 客户端\n      const client = new COS({\n        getAuthorization: (options, callback) => {\n          const now = Math.floor(Date.now() / 1000);\n          let expiredTime;\n\n          // 逻辑：如果 expireTime 是 10 位及以上的数字，直接当作秒使用；\n          // 否则尝试用 Date 对象解析（支持 ISO 字符串如 stsData.expiration）\n          if (typeof stsData.expireTime === 'number' && stsData.expireTime > 1000000000) {\n            expiredTime = stsData.expireTime;\n          } else {\n            const expDate = new Date(stsData.expiration || stsData.expireTime);\n            expiredTime = Math.floor(expDate.getTime() / 1000);\n          }\n\n          // 最终容错：如果解析失败或时间戳不合理，默认 1 小时过期\n          if (isNaN(expiredTime) || expiredTime <= now) {\n            expiredTime = now + 3600;\n          }\n\n          callback({\n            TmpSecretId: stsData.accessKeyId,\n            TmpSecretKey: stsData.accessKeySecret,\n            SecurityToken: stsData.securityToken,\n            StartTime: now,\n            ExpiredTime: expiredTime,\n          });\n        }\n      });\n\n      // 4. 路径处理\n      const originalName = normalizedFile.name || (normalizedFile.type ? `upload.${normalizedFile.type.split('/')[1]}` : \"unnamed\");\n      const fileName = (options.strictNameMode && options.fileName) || this.generateUniqueFileName(originalName, options.fileName);\n      const objectKey = `${stsData.object}/${fileName}`.replace(/\\/+/g, \"/\");\n\n      // 5. 执行上传\n      return new Promise((resolve, reject) => {\n        let uploadTaskId = null;\n        let isUploadActive = true;\n\n        // 暴露中止句柄\n        if (options.onAbortHandler) {\n          options.onAbortHandler(() => {\n            if (!isUploadActive) return\n            isUploadActive = false;\n            if (uploadTaskId) {\n              client.cancelTask(uploadTaskId);\n            }\n          });\n        }\n\n        // 暴露暂停句柄\n        if (options.onPauseHandler) {\n          options.onPauseHandler(() => {\n            if (!isUploadActive) return\n            isUploadActive = false;\n            if (uploadTaskId) {\n              client.pauseTask(uploadTaskId);\n            }\n          });\n        }\n\n        client.uploadFile({\n          Bucket: stsData.bucket,\n          Region: stsData.region,\n          Key: objectKey,\n          Body: uploadFile,\n          Headers: headers,\n          SliceSize: options.sliceSize || 1024 * 1024 * 10, // 默认 10MB 分片\n          onTaskReady: (taskId) => {\n            uploadTaskId = taskId;\n          },\n          onProgress: (progressData) => {\n            if (options.onProgress && isUploadActive) {\n              const percent = Math.floor(progressData.percent * 100);\n              options.onProgress(percent, progressData);\n            }\n          }\n        }, (err, data) => {\n          isUploadActive = false\n          if (err) {\n            if (err.name === 'cancel') {\n              console.log(\"CosUploader: Upload canceled by user\");\n            } else {\n              console.error(\"CosUploader: Upload failed\", err);\n            }\n            return reject(err);\n          }\n\n          // 构造结果\n          const finalUrl = stsData.domain \n            ? `${stsData.domain.replace(/\\/+$/, \"\")}/${objectKey.replace(/^\\/+/, \"\")}`\n            : `https://${data.Location}`;\n\n          resolve({\n            ...data,\n            fileName,\n            url: finalUrl,\n            originUrl: finalUrl,\n            stsData\n          });\n        });\n      });\n    } catch (error) {\n      console.error(\"CosUploader: Upload failed\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * 上传多个文件\n   */\n  async uploadMultiple(files, bizCode, options = {}) {\n    const promises = files.map((file, index) => {\n      return this.upload(file, bizCode, {\n        ...options,\n        onProgress: (p, cpt) => {\n          if (options.onItemProgress) {\n            options.onItemProgress(index, p, cpt);\n          }\n        },\n        onPauseHandler: (pauseFn) => {\n          if (options.onItemPauseTask) {\n            options.onItemPauseTask(index, pauseFn);\n          }\n        },\n        onAbortHandler: (abortFn) => {\n          if (options.onItemAbortTask) {\n            options.onItemAbortTask(index, abortFn);\n          }\n        },\n      });\n    });\n\n    return Promise.allSettled(promises);\n  }\n\n   /**\n   * 生成唯一文件名\n   */\n  generateUniqueFileName(originalName, fileName) {\n    const randomStr = uuidv4()\n    let ext = originalName.split(\".\").pop();\n    if(ext === 'unnamed' && fileName) {\n      ext = fileName.split(\".\").pop();\n    }\n    return `${randomStr}.${ext}`;\n  }\n\n  /**\n   * 清除所有 STS 缓存\n   */\n  static clearCache() {\n    STSProvider.clearCache();\n  }\n}\n\n"],"names":["readFileAsArrayBuffer","_x","_readFileAsArrayBuffer","apply","arguments","_asyncToGenerator","_regenerator","m","_callee3","file","w","_context3","n","a","Promise","resolve","reject","reader","FileReader","onload","result","onerror","readAsArrayBuffer","base64toHEX","base64","raw","window","atob","HEX","i","length","_hex","charCodeAt","toString","dataURLtoBlob","dataurl","Error","arr","split","mimeMatch","match","mime","bstr","u8arr","Uint8Array","Blob","type","sm4Encrypt","arrayBuffer","kmsDataKey","bytes","hexData","Array","from","map","b","padStart","join","hexDataKey","dataKey","encryptedHex","sm4","encrypt","slice","iv","mode","h","parseInt","createEncryptedBlob","_x2","_x3","_createEncryptedBlob","_callee4","_ref","encryptedData","_context4","v","CosUploader","_classCallCheck","stsProvider","STSProvider","_createClass","key","value","_upload","_callee","bizCode","options","normalizedFile","checkName","checkType","isHtml","errorMsg","stsData","uploadFile","headers","_yield$options$extern","encryptedFile","extraMeta","client","originalName","fileName","objectKey","_args","_t","_context","p","undefined","startsWith","name","toLowerCase","endsWith","allowHTML","alert","concat","getCredentials","encryptEnable","sm4Supported","String","version","dataKeyEncrypted","externalEncrypt","meta","Object","keys","forEach","console","warn","COS","getAuthorization","callback","now","Math","floor","Date","expiredTime","expireTime","expDate","expiration","getTime","isNaN","TmpSecretId","accessKeyId","TmpSecretKey","accessKeySecret","SecurityToken","securityToken","StartTime","ExpiredTime","strictNameMode","generateUniqueFileName","object","replace","uploadTaskId","isUploadActive","onAbortHandler","cancelTask","onPauseHandler","pauseTask","Bucket","bucket","Region","region","Key","Body","Headers","SliceSize","sliceSize","onTaskReady","taskId","onProgress","progressData","percent","err","data","log","error","finalUrl","domain","Location","_objectSpread","url","originUrl","upload","_x4","_x5","_uploadMultiple","_callee2","files","_this","promises","_args2","_context2","index","cpt","onItemProgress","pauseFn","onItemPauseTask","abortFn","onItemAbortTask","allSettled","uploadMultiple","_x6","_x7","randomStr","uuidv4","ext","pop","config","clearCache"],"mappings":"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"}