{"version":3,"file":"sts.js","sources":["../sts-provider.js"],"sourcesContent":["/**\n * OSS STS 凭证提供者\n * 用于获取阿里云 OSS 的临时访问凭证\n * \n * 使用方式：\n * 1. 全局配置一次（推荐在 Vue.use() 时配置）\n *    STSProvider.config({ httpClient: http, baseURL: '/api' })\n * \n * 2. 在需要的地方创建实例并获取凭证\n *    const provider = new STSProvider()\n *    const credentials = await provider.getCredentials({ bizCode: '70201' })\n */\n\nimport CryptoJS from 'crypto-js'\nimport { RSAKey } from 'jsrsasign'\nimport { sm4 } from 'sec-crypto'\n\nexport class STSProvider {\n  constructor(options = {}) {\n    // 支持实例级配置或使用全局配置\n    this.httpClient = options.httpClient || STSProvider.globalHttpClient\n    this.baseURL = options.baseURL || STSProvider.globalBaseURL || ''\n    \n    if (!this.httpClient) {\n      console.warn('STSProvider: httpClient not provided, please set it via constructor or STSProvider.config()')\n    }\n    \n    // 缓存公钥信息，避免重复请求\n    this.cache = {\n      modulus: null,\n      exponent: null,\n      cacheTime: null,\n      cacheExpire: 30 * 60 * 1000 // 缓存30分钟\n    }\n\n    // 凭证缓存池 (key: bizCode, value: { data, expireTime })\n    this.credentialPool = STSProvider.credentialPool\n    // 并发锁 (key: bizCode, value: Promise)\n    this.locks = STSProvider.locks\n  }\n  \n  // 静态缓存池\n  static credentialPool = new Map()\n  static locks = new Map()\n  \n  /**\n   * 全局配置 STSProvider\n   * @param {Object} options\n   * @param {Function} options.httpClient - HTTP 客户端函数\n   * @param {string} options.baseURL - API 基础路径\n   */\n  static config(options = {}) {\n    if (options.httpClient) {\n      STSProvider.globalHttpClient = options.httpClient\n    }\n    if (options.baseURL !== undefined) {\n      STSProvider.globalBaseURL = options.baseURL\n    }\n  }\n\n  /**\n   * 清除所有缓存\n   */\n  static clearCache() {\n    STSProvider.credentialPool.clear()\n    STSProvider.locks.clear()\n  }\n\n  /**\n   * 获取 STS 凭证（带缓存和并发锁）\n   * @param {Object} params\n   * @param {string} params.bizCode - 业务编码\n   * @returns {Promise<Object>}\n   */\n  async getCredentials({ bizCode }) {\n    if (!bizCode) {\n      throw new Error('STSProvider: bizCode is required')\n    }\n    \n    // 1. 检查缓存\n    const cached = this.credentialPool.get(bizCode)\n    const now = Date.now()\n    // 提前 60 秒失效，确保上传过程中凭证有效\n    if (cached && cached.expireTime && (now < cached.expireTime - 60000)) {\n      return cached.data\n    }\n\n    // 2. 并发锁：防止同一 bizCode 同时发起多个请求\n    if (this.locks.has(bizCode)) {\n      return this.locks.get(bizCode)\n    }\n\n    const requestPromise = this._doGetCredentials(bizCode).finally(() => {\n      this.locks.delete(bizCode)\n    })\n\n    this.locks.set(bizCode, requestPromise)\n    return requestPromise\n  }\n\n  /**\n   * 内部执行获取逻辑\n   */\n  async _doGetCredentials(bizCode) {\n    if (!this.httpClient) {\n      throw new Error('STSProvider: httpClient is not configured. Please call STSProvider.config() first.')\n    }\n\n    try {\n      // 1. 获取公钥质数对\n      const { modulus, exponent } = await this.getModulusExponent()\n      \n      // 2. 生成随机密钥\n      const secretKey = this.generateRandomKey(16) \n      const iv = this.generateRandomKey(16)\n      \n      // 3. RSA 加密\n      const encryptedKey = this.rsaEncrypt(secretKey, modulus, exponent)\n      const encryptedIv = this.rsaEncrypt(iv, modulus, exponent)\n      \n      // 4. 请求接口\n      const response = await this.fetchOssCredential({\n        bizCode,\n        key: encryptedKey,\n        iv: encryptedIv\n      })\n      \n      // 5. SM4 解密\n      const decrypted = this.decryptCredentials(response.data, secretKey, iv)\n      \n      // 6. 存入缓存池 (使用接口返回的 expireTime)\n      const expireTime = decrypted.expireTime || (Date.now() + 3600 * 1000)\n      this.credentialPool.set(bizCode, {\n        data: decrypted,\n        expireTime: expireTime\n      })\n      \n      return decrypted\n    } catch (error) {\n      console.error('STSProvider: Failed to get credentials', error)\n      throw error\n    }\n  }\n\n  /**\n   * 获取公钥质数对\n   * @returns {Promise<{modulus: string, exponent: string}>}\n   */\n  async getModulusExponent() {\n    // 检查缓存是否有效\n    const now = Date.now()\n    if (\n      this.cache.modulus && \n      this.cache.exponent && \n      this.cache.cacheTime &&\n      (now - this.cache.cacheTime < this.cache.cacheExpire)\n    ) {\n      return {\n        modulus: this.cache.modulus,\n        exponent: this.cache.exponent\n      }\n    }\n\n    // 调用接口获取（注意带上 actions 段）\n    const res = await this.httpClient(\n      'get',\n      `${this.baseURL}/v1/ossManager/ossManager/actions/getModulusExponent`\n    )\n    \n    if (res && +res.code === 0) {\n      this.cache.modulus = res.data.modulus\n      this.cache.exponent = res.data.exponent\n      this.cache.cacheTime = now\n      \n      return {\n        modulus: res.data.modulus,\n        exponent: res.data.exponent\n      }\n    }\n    \n    throw new Error('STSProvider: Failed to get modulus and exponent')\n  }\n\n  /**\n   * RSA 加密\n   * @param {string} data - 要加密的数据\n   * @param {string} modulus - 公钥模数（Base64）\n   * @param {string} exponent - 公钥指数（Base64）\n   * @returns {string} Base64 编码的加密结果\n   */\n  rsaEncrypt(data, modulus, exponent) {\n    try {\n      // 创建 RSA 密钥对象\n      const rsa = new RSAKey()\n      \n      // 将 Base64 编码的模数和指数转换为十六进制\n      const modulusHex = this.base64ToHex(modulus)\n      const exponentHex = this.base64ToHex(exponent)\n      \n      // 设置公钥\n      rsa.setPublic(modulusHex, exponentHex)\n      \n      // 加密数据（返回十六进制字符串）\n      const encrypted = rsa.encrypt(data)\n      \n      // 将十六进制转换为 Base64\n      return this.hexToBase64(encrypted)\n    } catch (error) {\n      console.error('STSProvider: RSA encryption failed', error)\n      throw new Error('RSA encryption failed: ' + error.message)\n    }\n  }\n\n  /**\n   * Base64 转十六进制\n   * @param {string} base64 - Base64 字符串\n   * @returns {string} 十六进制字符串\n   */\n  base64ToHex(base64) {\n    const raw = atob(base64)\n    let hex = ''\n    for (let i = 0; i < raw.length; i++) {\n      const byte = raw.charCodeAt(i).toString(16)\n      hex += (byte.length === 2 ? byte : '0' + byte)\n    }\n    return hex\n  }\n\n  /**\n   * 十六进制转 Base64\n   * @param {string} hex - 十六进制字符串\n   * @returns {string} Base64 字符串\n   */\n  hexToBase64(hex) {\n    const bytes = []\n    for (let i = 0; i < hex.length; i += 2) {\n      bytes.push(parseInt(hex.substr(i, 2), 16))\n    }\n    const binary = String.fromCharCode.apply(null, bytes)\n    return btoa(binary)\n  }\n\n  /**\n   * 生成随机密钥\n   * @param {number} length - 密钥长度\n   * @returns {string} 随机密钥\n   */\n  generateRandomKey(length) {\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'\n    let result = ''\n    for (let i = 0; i < length; i++) {\n      result += chars.charAt(Math.floor(Math.random() * chars.length))\n    }\n    return result\n  }\n\n  /**\n   * 调用获取 STS 凭证接口\n   * @param {Object} params - 请求参数\n   * @returns {Promise<Object>} 接口响应\n   */\n  async fetchOssCredential(params) {\n    const res = await this.httpClient(\n      'post',\n      `${this.baseURL}/v1/ossManager/ossManager/actions/getOssCredential`,\n      params\n    )\n    \n    if (res && +res.code === 0) {\n      return res\n    }\n    \n    throw new Error(res?.message || 'Failed to get OSS credentials')\n  }\n\n  /**\n   * 解密 STS 凭证中的加密字段\n   * @param {Object} data - 原始数据\n   * @param {string} secretKey - 密钥\n   * @param {string} iv - IV\n   * @returns {Object} 解密后的数据\n   */\n  decryptCredentials(data, secretKey, iv) {\n    const encryptedFields = [\n      'accessKeyId',\n      'accessKeySecret',\n      'bucket',\n      'domain',\n      'endpoint',\n      'object'\n    ]\n    \n    const decrypted = { ...data }\n    \n    encryptedFields.forEach(field => {\n      if (data[field]) {\n        try {\n          decrypted[field] = this.sm4Decrypt(data[field], secretKey, iv)\n        } catch (error) {\n          console.error(`STSProvider: Failed to decrypt field [${field}]`, error)\n          // 解密失败时保留原值\n        }\n      }\n    })\n    \n    return decrypted\n  }\n\n  /**\n   * SM4 解密 (CBC 模式)\n   * @param {string} encrypted - 加密的 Base64 字符串\n   * @param {string} key - 16 字节原始密钥字符串\n   * @param {string} iv - 16 字节原始 IV 字符串\n   * @returns {string} 解密后的字符串\n   */\n  sm4Decrypt(encrypted, key, iv) {\n    // 1. Base64 -> Hex\n    const encryptedHex = CryptoJS.enc.Base64.parse(encrypted).toString(CryptoJS.enc.Hex)\n\n    // 2. Key/IV -> Hex\n    const keyHex = CryptoJS.enc.Utf8.parse(key).toString(CryptoJS.enc.Hex)\n    const ivHex = CryptoJS.enc.Utf8.parse(iv).toString(CryptoJS.enc.Hex)\n\n    // 3. 执行解密\n    const decryptedHex = sm4.decrypt(encryptedHex, keyHex, {\n      mode: 'cbc',\n      iv: ivHex,\n      padding: 'pkcs7'\n    })\n\n    if (!decryptedHex) return ''\n\n    try {\n      // 4. Hex -> Utf8\n      let result = CryptoJS.enc.Hex.parse(decryptedHex).toString(CryptoJS.enc.Utf8)\n      \n      // 5. 【关键修复】手动剔除末尾的 PKCS7 填充字符\n      // PKCS7 填充的字符编码通常在 0x01 到 0x10 (16) 之间\n      // 使用正则匹配末尾的所有不可见控制字符并替换为空\n      // eslint-disable-next-line no-control-regex\n      return result.replace(/[\\x00-\\x1F\\x7F]+$/g, '')\n    } catch (e) {\n      console.error('STSProvider: Decryption or encoding conversion failed', e)\n      return decryptedHex\n    }\n  }\n\n  /**\n   * 清除缓存\n   */\n  clearCache() {\n    this.cache = {\n      modulus: null,\n      exponent: null,\n      cacheTime: null,\n      cacheExpire: 30 * 60 * 1000\n    }\n  }\n}\n\n// 初始化静态属性\nSTSProvider.globalHttpClient = null\nSTSProvider.globalBaseURL = ''\n\n"],"names":["STSProvider","options","arguments","length","undefined","_classCallCheck","httpClient","globalHttpClient","baseURL","globalBaseURL","console","warn","cache","modulus","exponent","cacheTime","cacheExpire","credentialPool","locks","_createClass","key","value","_getCredentials","_asyncToGenerator","_regenerator","m","_callee","_ref","_this","bizCode","cached","now","requestPromise","w","_context","n","Error","get","Date","expireTime","a","data","has","_doGetCredentials","finally","delete","set","getCredentials","_x","apply","_doGetCredentials2","_callee2","_yield$this$getModulu","secretKey","iv","encryptedKey","encryptedIv","response","decrypted","_t","_context2","p","getModulusExponent","v","generateRandomKey","rsaEncrypt","fetchOssCredential","decryptCredentials","error","_x2","_getModulusExponent","_callee3","res","_context3","concat","code","rsa","RSAKey","modulusHex","base64ToHex","exponentHex","setPublic","encrypted","encrypt","hexToBase64","message","base64","raw","atob","hex","i","byte","charCodeAt","toString","bytes","push","parseInt","substr","binary","String","fromCharCode","btoa","chars","result","charAt","Math","floor","random","_fetchOssCredential","_callee4","params","_context4","_x3","_this2","encryptedFields","_objectSpread","forEach","field","sm4Decrypt","encryptedHex","CryptoJS","enc","Base64","parse","Hex","keyHex","Utf8","ivHex","decryptedHex","sm4","decrypt","mode","padding","replace","e","clearCache","config","clear","_defineProperty","Map"],"mappings":"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"}